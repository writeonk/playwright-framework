name: ğŸ§ª Daily Playwright Tests with Allure

on:
  schedule:
    - cron: '0 6 * * *' # â° Run daily at 6 AM UTC
  workflow_dispatch:     # ğŸ§­ Allow manual run

jobs:
  test-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ³ Build Playwright Docker image
        run: docker build -t playwright-tests .

      - name: ğŸ§ª Run Playwright tests in container
        run: |
          docker run --rm \
            --env-file .env \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            playwright-tests

      - name: ğŸ“Š Generate Allure Report (in separate container)
        uses: addnab/docker-run-action@v3
        with:
          image: frankescobar/allure-docker-service
          options: -v ${{ github.workspace }}/allure-results:/app/allure-results -v ${{ github.workspace }}/allure-report:/app/allure-report
          run: allure generate /app/allure-results --clean -o /app/allure-report

      - name: ğŸ“ Upload Allure Report (artifact for team)
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: ğŸ”” Notify Slack on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        with:
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: 'âŒ Playwright tests failed. See Allure report in GitHub Actions artifacts.'